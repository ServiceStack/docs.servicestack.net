---
title: ServiceStack v6.5
---

<div class="not-prose pt-8 my-8 ml-20 flex flex-col items-center">
    <div>
        <svg class="w-40 h-40 text-gray-800 mr-8" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M9.37 5.51A7.35 7.35 0 0 0 9.1 7.5c0 4.08 3.32 7.4 7.4 7.4c.68 0 1.35-.09 1.99-.27A7.014 7.014 0 0 1 12 19c-3.86 0-7-3.14-7-7c0-2.93 1.81-5.45 4.37-6.49zM12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26a5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg>
    </div>
    <h2 id="darkmode" class="border-none text-4xl sm:text-5xl md:text-6xl tracking-tight font-extrabold">
        <span class="text-gray-800 mr-6">Dark Mode</span>
    </h2>
</div>

This was another Blazor focused release packed with new components & features we're excited to share - first up Dark Mode everywhere!

![](/img/pages/blazor/dark-and-light-mode.png)

[Tailwind](https://tailwindcss.com) has revolutionized how we style our Web Apps with its [mobile first](https://tailwindcss.com/#mobile-first) design system that's dramatically simplified creating maintainable responsive Web Apps. It also excels at adding support for [Dark Mode](https://tailwindcss.com/#dark-mode) with its first-class **dark:** modifier allowing the use of standard tailwind classes to specify what elements should look like when viewed in **Dark Mode**, e.g:

<div class="not-prose relative bg-slate-50 rounded-xl overflow-hidden dark:bg-slate-800/25"><div style="background-position:10px 10px" class="absolute inset-0 bg-grid-slate-100 [mask-image:linear-gradient(0deg,#fff,rgba(255,255,255,0.6))] dark:bg-grid-slate-700/25 dark:[mask-image:linear-gradient(0deg,rgba(255,255,255,0.1),rgba(255,255,255,0.5))]"></div><div class="relative rounded-xl overflow-auto">
  <div class="grid grid-cols-1 sm:grid-cols-2">
    <div class="p-8 pt-7">
      <p class="mb-2 text-sm font-medium text-slate-500">Light mode</p>
      <div class="bg-white rounded-lg px-6 py-8 ring-1 ring-slate-900/5 shadow-xl">
        <div>
          <span class="inline-flex items-center justify-center p-2 bg-indigo-500 rounded-md shadow-lg">
            <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
          </span>
        </div>
        <h3 class="mt-5 text-base font-medium text-slate-900 tracking-tight">Writes Upside-Down</h3>
        <p class="mt-2 text-sm text-slate-500">
          The Zero Gravity Pen can be used to write in any orientation, including upside-down. It even works in outer space.
        </p>
      </div>
    </div>
    <div class="bg-slate-900 p-8 pt-7">
      <p class="mb-2 text-sm font-medium text-slate-400">Dark mode</p>
      <div class="bg-slate-800 rounded-lg px-6 py-8 ring-1 ring-slate-900/5 shadow-xl">
        <div>
          <span class="inline-flex items-center justify-center p-2 bg-indigo-500 rounded-md shadow-lg">
            <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
          </span>
        </div>
        <h3 class="mt-5 text-base font-medium text-white tracking-tight">Writes Upside-Down</h3>
        <p class="mt-2 text-sm text-slate-400">
          The Zero Gravity Pen can be used to write in any orientation, including upside-down. It even works in outer space.
        </p>
      </div>
    </div>
  </div>
</div><div class="absolute inset-0 pointer-events-none border border-black/5 rounded-xl dark:border-white/5"></div></div>

```html
<div class="bg-white dark:bg-slate-800 rounded-lg px-6 py-8 ring-1 ring-slate-900/5 shadow-xl">
  <div>
    <span class="inline-flex items-center justify-center p-2 bg-indigo-500 rounded-md shadow-lg">
      <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><!-- ... --></svg>
    </span>
  </div>
  <h3 class="text-slate-900 dark:text-white mt-5 text-base font-medium tracking-tight">Writes Upside-Down</h3>
  <p class="text-slate-500 dark:text-slate-400 mt-2 text-sm">
    The Zero Gravity Pen can be used to write in any orientation, including upside-down. It even works in outer space.
  </p>
</div>
```

### View ServiceStack.Blazor in Dark Mode

We're happy to announce that Dark Mode support has been added to **all ServiceStack.Blazor components** and all Blazor Tailwind project templates where you'll be able to toggle on/off Dark Mode with the new `<DarkModeToggle>` component. Checkout this video to see how beautiful Dark Mode looks like in the latest ServiceStack.Blazor Components and Tailwind project templates:

<div class="my-8 flex justify-center">
    <lite-youtube class="w-full mx-4 my-4" width="560" height="315" videoid="8nwpC_B4AC4" style="background-image: url('https://img.youtube.com/vi/8nwpC_B4AC4/maxresdefault.jpg')"></lite-youtube>
</div>

For a more interactive view, use the right Dark Mode toggle to turn on/off Dark Mode in the embedded [Blazor Gallery Contacts Page](https://blazor-gallery.jamstacks.net/grid/contacts-meta):

<iframe src="https://blazor-gallery.jamstacks.net/grid/contacts-meta/embed" class="w-full border-none h-[970px]"></iframe>

Dark Mode is all implemented with CSS, controlled by toggling the **dark** class on the `<html class="dark">` element, `<DarkModeToggle>` also saves this user preference in `localStorage` where it's preserved across browser restarts.

### View in Dark Mode

The Blazor Tailwind templates also include the ability to override the users color scheme preference and open a page in dark or light mode with the 
`?dark` and `?light` query params:

<div class="not-prose relative">
  <div class="grid grid-cols-1 sm:grid-cols-2 text-center">
    <div>
        <a class="flex flex-col" href="https://blazor-server.jamstacks.net/?light">
            <div class="py-4">blazor-server.jamstacks.net/?light</div>
            <img class="rounded-xl overflow-hidden" src="/img/pages/blazor/blazor-gallery-light.png">
        </a>
    </div>
    <div>
        <a class="flex flex-col" href="https://blazor-server.jamstacks.net/?dark">
            <div class="py-4">blazor-server.jamstacks.net/?dark</div>
            <img class="rounded-xl overflow-hidden" src="/img/pages/blazor/blazor-gallery-dark.png">
        </a>
    </div>
  </div>
</div>

### Force Dark Mode

If your App is best viewed in Dark Mode you can force it to use Dark Mode with `JS.init()` when initializing ServiceStack.Blazor's JS library in Blazor Server's **_Layout.cshtml** or Blazor WASM's **index.html**, e.g:

```html
<script src="_framework/blazor.server.js"></script>
<script src="/js/servicestack-blazor.js"></script>
<script>JS.init({ colorScheme:'dark' })</script>
```

<p class="hide-h2"></p>

## Blazor Components

<div class="pt-8 my-8 ml-20 flex flex-col items-center">
    <div>
        <svg class="w-40 h-40 text-purple-600 mr-8" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M23.834 8.101a13.912 13.912 0 0 1-13.643 11.72a10.105 10.105 0 0 1-1.994-.12a6.111 6.111 0 0 1-5.082-5.761a5.934 5.934 0 0 1 11.867-.084c.025.983-.401 1.846-1.277 1.871c-.936 0-1.374-.668-1.374-1.567v-2.5a1.531 1.531 0 0 0-1.52-1.533H8.715a3.648 3.648 0 1 0 2.695 6.08l.073-.11l.074.121a2.58 2.58 0 0 0 2.2 1.048a2.909 2.909 0 0 0 2.695-3.04a7.912 7.912 0 0 0-.217-1.933a7.404 7.404 0 0 0-14.64 1.603a7.497 7.497 0 0 0 7.308 7.405s.549.05 1.167.035a15.803 15.803 0 0 0 8.475-2.528c.036-.025.072.025.048.061a12.44 12.44 0 0 1-9.69 3.963a8.744 8.744 0 0 1-8.9-8.972a9.049 9.049 0 0 1 3.635-7.247a8.863 8.863 0 0 1 5.229-1.726h2.813a7.915 7.915 0 0 0 5.839-2.578a.11.11 0 0 1 .059-.034a.112.112 0 0 1 .12.053a.113.113 0 0 1 .015.067a7.934 7.934 0 0 1-1.227 3.549a.107.107 0 0 0-.014.06a.11.11 0 0 0 .073.095a.109.109 0 0 0 .062.004a8.505 8.505 0 0 0 5.913-4.876a.155.155 0 0 1 .055-.053a.15.15 0 0 1 .147 0a.153.153 0 0 1 .054.053A10.779 10.779 0 0 1 23.834 8.1zM8.895 11.628a2.188 2.188 0 1 0 2.188 2.188v-2.042a.158.158 0 0 0-.15-.15Z"/></svg>
    </div>
    <h2 class="border-none text-4xl sm:text-5xl md:text-6xl tracking-tight font-extrabold">
        <span class="text-purple-600 mr-6">Blazor Components</span>
    </h2>
</div>

The [ServiceStack.Blazor](https://servicestack.net/blazor) component library continues to expand with exciting new Components and improvements.

## Autocomplete

First up is the `<Autocomplete>` component that provides a user friendly Input for being able to search and quickly select items, that includes support for rich templated content, custom matching and infinite scrolling that avoids pre-loading the entire bound list of items. 

Instead of being populated with a fixed List of strings or Key Value Pairs the Autocomplete component can bind directly to a list of POCOs to render its templated content where you'll be able to specify a custom `Match` filter to control which filtered items are displayed, that it can fuzzy match on single or multiple POCO properties.

### Single Contact

Here's a simple Autocomplete example that binds to a **simple** `Contact` from a `List<Contact>` in **allContacts**:

```html
<Autocomplete T="Contact" Options="allContacts" @bind-Value="simple" Label="Single Contact"
    Match="(x, value) => x!.DisplayName.Contains(value, StringComparison.OrdinalIgnoreCase)"
    placeholder="Select Contact">
    <Item>
        <span class="block truncate">@context!.DisplayName</span>
    </Item>
</Autocomplete>
```

### Single Contact with Icon

The item content is templated allowing for rich content which can be used to display a Contact's profile picture and name:

```html
<Autocomplete T="Contact" Options="allContacts" @bind-Value="contact" Label="Single Contact with Icon"
    Match="(x, value) => x!.DisplayName.Contains(value, StringComparison.OrdinalIgnoreCase)"
    placeholder="Select Contact">
    <Item>
        <div class="flex items-center">
            <Icon class="h-6 w-6 flex-shrink-0 rounded-full" Src=@context.ProfileUrl />
            <span class="ml-3 truncate">@context!.DisplayName</span>
        </div>
    </Item>
</Autocomplete>
```

### Multiple Contacts with Icon

It also supports multiple selection by using `@bind-Values` to bind to the `List<Contact>` in **contacts** instead, e.g:

```html
<Autocomplete Options="allContacts" @bind-Values="contacts" Label="Multiple Contacts with Icon"
    Match="(x, value) => x!.DisplayName.Contains(value, StringComparison.OrdinalIgnoreCase)"
    placeholder="Select Contacts">
    <Item>
        <div class="flex items-center">
            <Icon class="h-6 w-6 flex-shrink-0 rounded-full" Src=@context.ProfileUrl />
            <span class="ml-3 truncate">@context!.DisplayName</span>
        </div>
    </Item>
</Autocomplete>
```

and here's a working example of what they look like together in the same form ([example source code](https://blazor-gallery.jamstacks.net/gallery/inputs)):

<div class="pt-12 flex justify-center">
    <iframe src="https://blazor-gallery.jamstacks.net/gallery/inputs/autocomplete" class="w-[500px] border-none h-[560px]"></iframe>
</div>

## TagInput

The TagInput component is useful for when you want to manage a list of strings like words or tags - an input that's notably lacking in HTML Forms.
Best of all `<TagInput>` functions like any other input where it can be included and customized in declarative forms. 

For example this Update AutoQuery Request DTO:

```csharp
// Customize Edit Forms with [Input] and [FieldCss] attributes 
public class UpdateContact : IPatchDb<Contact>, IReturn<Contact>
{
    public int Id { get; set; }

    [ValidateNotEmpty]
    public string? FirstName { get; set; }

    [ValidateNotEmpty]
    public string? LastName { get; set; }

    [Input(Type = "file"), UploadTo("profiles")]
    public string? ProfileUrl { get; set; }
    
    public int? SalaryExpectation { get; set; }

    [ValidateNotEmpty]
    public string? JobType { get; set; }

    public int? AvailabilityWeeks { get; set; }
    public EmploymentType? PreferredWorkType { get; set; }
    public string? PreferredLocation { get; set; }

    [ValidateNotEmpty]
    public string? Email { get; set; }
    public string? Phone { get; set; }
    
    [Input(Type = "tag"), FieldCss(Field = "col-span-12")]
    public List<string>? Skills { get; set; }}
 
    [Input(Type="textarea")]
    [FieldCss(Field="col-span-12 text-center", Input="h-48", Label="text-xl text-indigo-700")]
    public string? About { get; set; }
}
```

is all that's needed to render an instantly working API-enabled Form with validation binding using 
[Auto Form components](https://blazor-gallery.jamstacks.net/gallery/autoform):

```html
<AutoEditForm class=@Class Model="Contact" ApiType="typeof(UpdateContact)" Edit=@contact />
```

Which by default renders the form in a SlideOver dialog as seen when editing a row in the [Contacts AutoQueryGrid](https://blazor-gallery.jamstacks.net/grid/contacts-meta?edit=1) component:

<iframe src="https://blazor-gallery.jamstacks.net/grid/contacts-meta/embed?edit=1" class="mt-8 w-full border-none h-[970px]"></iframe>

Alternatively it can be rendered in a traditional **"card"** form layout with the new `FormStyle.Card` option:

```html
<AutoEditForm class=@Class FormStyle="FormStyle.Card" Model="Contact" ApiType="typeof(UpdateContact)" Edit=@contact />
```

<iframe src="https://blazor-gallery.jamstacks.net/gallery/inputs/tag?layout=ExampleLayout&class=max-w-screen-md+mx-auto" class="mt-8 w-full border-none h-[1570px]"></iframe>

Where it functions the same as other Input components where it can be bound directly to a `List<string>` Request DTO property:

```html
<form @onsubmit="submit" @onsubmit:preventDefault class=@Class>
<CascadingValue Value=@apiQuery.Error>
    <div class="shadow sm:rounded-md bg-white dark:bg-black">
        <div class="relative px-4 py-5 sm:p-6">
            <fieldset>
                <ErrorSummary Except=@VisibleFields />

                <div class="grid grid-cols-12 gap-6">
                    <div class="col-span-6">
                        <TextInput @bind-Value="request.FirstName" />
                    </div>

                    <div class="col-span-6">
                        <TextInput @bind-Value="request.LastName" />
                    </div>

                    <div class="col-span-12">
                        <TagInput @bind-Value="request.Skills" />
                    </div>
                </div>
            </fieldset>
        </div>
    </div>
</CascadingValue>
</form>
```

### NavList

The NavList component encapsulates Tailwind's beautiful List component which is used extensively in [Blazor Gallery's Navigation](https://blazor-gallery.jamstacks.net/grid):

```html
<div class="max-w-screen-sm">
    <NavList Title="Explore Blazor Components">
        <NavListItem Title="DataGrid" href="/gallery/datagrid" IconSvg=@Icons.DataGrid>
            DataGrid Component Examples for rendering tabular data
        </NavListItem>
        <NavListItem Title="AutoQuery Grid" href="/gallery/autoquerygrid" IconSvg=@Icons.AutoQueryGrid>
            Instant customizable UIs for calling AutoQuery CRUD APIs
        </NavListItem>
    </NavList>

    <h2 class="mt-8 text-base font-semibold text-gray-500 dark:text-gray-400 flex">
        <span title="Requires Auth"><Icon class="h-6 w-6 mr-2" Svg=@Icons.Padlock /></span>
        Booking APIs
    </h2>
    <NavList>
        <NavListItem Title="Bookings" href="/grid/bookings" Icon=@typeof(Booking).GetIcon()>
            Create and manage Bookings
        </NavListItem>
        <NavListItem Title="Coupons" href="/grid/coupons" Icon=@typeof(Coupon).GetIcon()>
            Create and manage discount Coupons
        </NavListItem>
    </NavList>
</div>
```

Where it will render a list of navigation links with descriptions and icons:

<div class="my-8 flex justify-center">
    <iframe src="https://blazor-gallery.jamstacks.net/gallery/navigation/navlist" class="my-8 w-full h-[510px] border-none"></iframe>
</div>

### Colored Buttons

The new `ButtonStyle` on PrimaryButton component can be used to render buttons into Tailwind's different primary colors:

```csharp
<div class="grid gap-4 grid-cols-3">
    <PrimaryButton>Default</PrimaryButton>
    <PrimaryButton Style="ButtonStyle.Blue">Blue</PrimaryButton>
    <PrimaryButton Style="ButtonStyle.Purple">Purple</PrimaryButton>
    <PrimaryButton Style="ButtonStyle.Red">Red</PrimaryButton>
    <PrimaryButton Style="ButtonStyle.Green">Green</PrimaryButton>
    <PrimaryButton Style="ButtonStyle.Sky">Sky</PrimaryButton>
    <PrimaryButton Style="ButtonStyle.Cyan">Cyan</PrimaryButton>
</div>
```

<div class="my-8 flex justify-center">
    <iframe src="https://blazor-gallery.jamstacks.net/gallery/navigation/buttons/styles" class="my-8 w-full h-[160px] border-none"></iframe>
</div>

### Select Input

The existing `<SelectInput>` has new additional `Values` and `Entries` parameters for populating options from an array of string's or KeyValuePair's, it also gains new declarative features enabling more capable declarative forms which are typically restricted by the compile-time constant expression limitation of .NET attributes. 

The new `EvalAllowableValues` and `EvalAllowableEntries` attribute properties overcomes this limitation by letting you define the Select options with a [#Script](https://sharpscript.net) Expression whose great [.NET scriptability](https://sharpscript.net/docs/script-net) lets you reference your App's .NET instances from a string expression. This feature can then be used to populate declarative Select options from a .NET Instance, e.g:

```csharp
public class CreateModifier : ICreateDb<Modifier>, IReturn<Modifier>
{
    [ValidateNotEmpty]
    public string Name { get; set; }

    [ValidateNotEmpty]
    [Input(Type="select", EvalAllowableValues = "AppData.Categories")]
    public string Category { get; set; }
 
    public string? Description { get; set; }
}
```

That we register as a global variable in our AppHost's `ScriptContext` which we can populate from a dynamic source like a DB Table, e.g:

```csharp
using var db = container.Resolve<IDbConnectionFactory>().Open();
ScriptContext.Args[nameof(AppData)] = new AppData
{
    Categories = db.Column<string>(db.From<Category>().Select(x => x.Name))
};
```

Where it will populate the Select input in all `CreateModifier` Auto Form components:

<div class="mt-8 flex justify-center">
    <img src="/img/pages/blazor/diffusion-CreateModifier.png" class="max-w-screen-md" style="border:1px solid #CACACA">
</div>

## AutoQueryGrid 

Our flagship [AutoQueryGrid Component](https://blazor-gallery.jamstacks.net/grid) continues to receive new improvements and features that make it more capable of supporting more use cases.

### ToolbarButtons

The `<ToolbarButtons>` element can be used to customize the AutoQueryGrid to add your own custom Toolbar buttons, e.g:

```html
<AutoQueryGrid>
  <ToolbarButtons>
    <div class="pl-2"><button>1</button></div>
    <div class="pl-2"><button>2</button></div>
  </ToolbarButtons>
</AutoQueryGrid>
```

 Enabling complete control over the Toolbar as all existing toolbar buttons can be removed with [AutoQueryGrid parameters](https://reference.servicestack.net/api/ServiceStack.Blazor.Components.Tailwind/AutoQueryGrid%60Model%60).

### Custom Edit and Create Forms

The `<CreateForm>` and `<EditForm>` elements can be used to replace the default [Auto Forms](https://blazor-gallery.jamstacks.net/gallery/autoform) used in creating and editing rows when more advanced or customized functionality is needed.

With this feature we can create a Custom AutoQueryGrid component that uses Custom Edit & Create Forms when selecting and adding new records and also customize the Grid results displayed with the new `ConfigureQuery` parameter to ensure results are filtered to the selected Tenant records:

```html
<AutoQueryGrid @ref=@grid Model="Item" Apis="Apis.AutoQuery<QueryItems,NewItem,EditItem>()" ConfigureQuery="Configure">
    <CreateForm>
        <div class="relative z-10">
            <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16">
                <CustomCreateItem OnClose="grid!.OnEditDone" />
            </div>
        </div>
    </CreateForm>
    <EditForm>
        <div class="relative z-10">
            <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16">
                <CustomEditItem Item="context" OnClose="grid!.OnEditDone" />
            </div>
        </div>
    </EditForm>
</AutoQueryGrid>

@code {
    AutoQueryGrid<Creative>? grid;
    [Parameter, SupplyParameterFromQuery] public int? TenantId { get; set; }

    void Configure(QueryBase query)
    {
        query.AddQueryParam("TenantId", TenantId);
    }
}
```

### Managing Filters & Preferences

By default the AutoQueryGrid displays the user's selected columns and query limit preferences which are persisted in localStorage. 
They can be overridden with the new **Prefs** attribute which has different ergonomic methods for configuration within an attribute:

To limit the Query Results Limit:

```html
<AutoQueryGrid @ref=@grid Model="Contact" Apis="Apis.AutoQuery<QueryContacts,CreateContact,UpdateContact>()"
               Prefs="ApiPrefs.Create(take:10)" />
```

To limit which columns are displayed in the Query Results:

```html
<AutoQueryGrid @ref=@grid Model="Contact" Apis="Apis.AutoQuery<QueryContacts,CreateContact,UpdateContact>()"
               Prefs="ApiPrefs.Columns(nameof(Contact.Id), nameof(Contact.LastName))" />
```

```html
<AutoQueryGrid @ref=@grid Model="Contact" Apis="Apis.AutoQuery<QueryContacts,CreateContact,UpdateContact>()"
               Prefs="ApiPrefs.Columns<Contact>(x => new { x.Id, x.LastName, x.Email })" />
```

To configure both Query Limit and Selected Columns:

```html
<AutoQueryGrid @ref=@grid Model="Contact" Apis="Apis.AutoQuery<QueryContacts,CreateContact,UpdateContact>()"
               Prefs="ApiPrefs.Create(take:10, columns:new(){ nameof(Contact.Id), nameof(Contact.LastName) })" />
```

```html
<AutoQueryGrid @ref=@grid Model="Contact" Apis="Apis.AutoQuery<QueryContacts,CreateContact,UpdateContact>()"
               Prefs="ApiPrefs.Configure(x => { x.Take = 5; x.SelectedColumns=new() { nameof(Contact.LastName) }; })"/>
```

In addition the new methods below can be used to clear any user-defined query filters and column preferences:

| Method | Description |
|--|--|
| grid.ClearFiltersAsync()     | Remove user-defined Filters |
| grid.ResetPreferencesAsync() | Remove user-defined Filters and Column Preferences |


### Disable Column Filtering

By default Filtering and Sorting are disabled for complex type columns, they can also be explicitly disabled per column with `AllowFiltering`, e.g:

```html
<AutoQueryGrid>
    <Column Field="(Contact x) => x.Phone" AllowFiltering="false" />
<AutoQueryGrid>
```

## Blazor Diffusion 

The goal of our increasing Blazor investments is to enable a highly productive and capable platform for rapidly developing a majority of internal Apps CRUD functionality as well as enabling a hybrid development model where the management of Back office supporting tables can be quickly implemented using custom AutoQueryGrid components freeing up developers to be able to focus a majority of their efforts where they add the most value - in the bespoke Blazor UI's optimized customer-facing UX.

To best demonstrate its potential we've embarked on development of a new project we're excited to announce that does exactly this!

<div class="not-prose my-8 flex justify-center">
    <a href="https://blazordiffusion.com" class="flex items-center hover:no-underline" title="blazordiffusion.com">
        <svg class="w-20 h-20 text-purple-600 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M23.834 8.101a13.912 13.912 0 0 1-13.643 11.72a10.105 10.105 0 0 1-1.994-.12a6.111 6.111 0 0 1-5.082-5.761a5.934 5.934 0 0 1 11.867-.084c.025.983-.401 1.846-1.277 1.871c-.936 0-1.374-.668-1.374-1.567v-2.5a1.531 1.531 0 0 0-1.52-1.533H8.715a3.648 3.648 0 1 0 2.695 6.08l.073-.11l.074.121a2.58 2.58 0 0 0 2.2 1.048a2.909 2.909 0 0 0 2.695-3.04a7.912 7.912 0 0 0-.217-1.933a7.404 7.404 0 0 0-14.64 1.603a7.497 7.497 0 0 0 7.308 7.405s.549.05 1.167.035a15.803 15.803 0 0 0 8.475-2.528c.036-.025.072.025.048.061a12.44 12.44 0 0 1-9.69 3.963a8.744 8.744 0 0 1-8.9-8.972a9.049 9.049 0 0 1 3.635-7.247a8.863 8.863 0 0 1 5.229-1.726h2.813a7.915 7.915 0 0 0 5.839-2.578a.11.11 0 0 1 .059-.034a.112.112 0 0 1 .12.053a.113.113 0 0 1 .015.067a7.934 7.934 0 0 1-1.227 3.549a.107.107 0 0 0-.014.06a.11.11 0 0 0 .073.095a.109.109 0 0 0 .062.004a8.505 8.505 0 0 0 5.913-4.876a.155.155 0 0 1 .055-.053a.15.15 0 0 1 .147 0a.153.153 0 0 1 .054.053A10.779 10.779 0 0 1 23.834 8.1zM8.895 11.628a2.188 2.188 0 1 0 2.188 2.188v-2.042a.158.158 0 0 0-.15-.15Z"/></svg>
        <h2 class="border-none text-4xl sm:text-5xl md:text-6xl tracking-tight font-extrabold">
            <span class="text-purple-600 mr-6">Diffusion</span>
        </h2>
    </a>
</div>

[![blazordiffusion.com](/img/pages/blazor/blazordiffusion.com_splash.png)](https://blazordiffusion.com)

[blazordiffusion.com](https://blazordiffusion.com) is a new ServiceStack.Blazor App front-end for [Stable Diffusion](https://en.wikipedia.org/wiki/Stable_Diffusion) - a deep learning text-to-image model that can generate quality images from a text prompt whose ability to run on commodity GPU hardware makes it 
one of the most exciting Open Source AI projects ever released. If you haven't experienced Stable Diffusion yet, we welcome you to create an account and start building your Stable Diffusion portfolio for FREE!

### Effortless Admin Pages

It's a great example of Hybrid Development in action where the entire user-facing UI is a bespoke Blazor App that's optimized for creating, searching, cataloging and discovering Stable Diffusion generated images, whilst all its supporting admin tasks to manage the back office tables that power the UI were effortlessly implemented with custom AutoQueryGrid components. 

To get a glimpse of this in action we've created a video showing how quick it was to build the first few Admin Pages:

<div class="my-8 flex justify-center">
    <lite-youtube class="w-full mx-4 my-4" width="560" height="315" videoid="tt0ytzVVjEY" style="background-image: url('https://img.youtube.com/vi/tt0ytzVVjEY/maxresdefault.jpg')"></lite-youtube>
</div>

Blazor Diffusion is an example of a real-world App leveraging a number of different ServiceStack features to achieve its functionality that we're using to ["dog food"](https://en.wikipedia.org/wiki/Eating_your_own_dog_food) new ServiceStack features to help identify any friction points or missing functionality that we can feedback into the design and improvements of new and existing features, which it has done for most of the new features in this release.

### Blazor Server or Blazor WASM

To ensure all new ServiceStack.Blazor features continue to work in both Blazor Server and Blazor WASM we're maintaining identical versions of Blazor Diffusion running in both of Blazor's hosting modes:

<div class="py-8 flex justify-center">
    <div class="flex flex-col">
    <a href="https://github.com/NetCoreApps/BlazorDiffusion" class="flex text-xl text-gray-800">
        <svg class="w-6 h-6 mr-2 align-text-bottom" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 .297c-6.63 0-12 5.373-12 12c0 5.303 3.438 9.8 8.205 11.385c.6.113.82-.258.82-.577c0-.285-.01-1.04-.015-2.04c-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729c1.205.084 1.838 1.236 1.838 1.236c1.07 1.835 2.809 1.305 3.495.998c.108-.776.417-1.305.76-1.605c-2.665-.3-5.466-1.332-5.466-5.93c0-1.31.465-2.38 1.235-3.22c-.135-.303-.54-1.523.105-3.176c0 0 1.005-.322 3.3 1.23c.96-.267 1.98-.399 3-.405c1.02.006 2.04.138 3 .405c2.28-1.552 3.285-1.23 3.285-1.23c.645 1.653.24 2.873.12 3.176c.765.84 1.23 1.91 1.23 3.22c0 4.61-2.805 5.625-5.475 5.92c.42.36.81 1.096.81 2.22c0 1.606-.015 2.896-.015 3.286c0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
        <span>NetCoreApps/BlazorDiffusion</span>
    </a>
    <a href="https://github.com/NetCoreApps/BlazorDiffusionWasm" class="flex mt-2 text-xl text-gray-800">
        <svg class="w-6 h-6 mr-2 align-text-bottom" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 .297c-6.63 0-12 5.373-12 12c0 5.303 3.438 9.8 8.205 11.385c.6.113.82-.258.82-.577c0-.285-.01-1.04-.015-2.04c-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729c1.205.084 1.838 1.236 1.838 1.236c1.07 1.835 2.809 1.305 3.495.998c.108-.776.417-1.305.76-1.605c-2.665-.3-5.466-1.332-5.466-5.93c0-1.31.465-2.38 1.235-3.22c-.135-.303-.54-1.523.105-3.176c0 0 1.005-.322 3.3 1.23c.96-.267 1.98-.399 3-.405c1.02.006 2.04.138 3 .405c2.28-1.552 3.285-1.23 3.285-1.23c.645 1.653.24 2.873.12 3.176c.765.84 1.23 1.91 1.23 3.22c0 4.61-2.805 5.625-5.475 5.92c.42.36.81 1.096.81 2.22c0 1.606-.015 2.896-.015 3.286c0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
        <span>NetCoreApps/BlazorDiffusionWasm</span>
    </a>
    </div>
</div>

Where it's initially developed from a Blazor Server project template to take advantage of its fast iterative dev model then uses a [script to export](https://github.com/NetCoreApps/BlazorDiffusionWasm/blob/main/sync.bat) all Pages and Server functionality to a Blazor WASM project template that's optimal for Internet deployments.

### Blazor Diffusion Features

To help discovery we'll link to where new features in this release are used.

<svg class="w-20 h-20 text-gray-800" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M9.37 5.51A7.35 7.35 0 0 0 9.1 7.5c0 4.08 3.32 7.4 7.4 7.4c.68 0 1.35-.09 1.99-.27A7.014 7.014 0 0 1 12 19c-3.86 0-7-3.14-7-7c0-2.93 1.81-5.45 4.37-6.49zM12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26a5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg>

### Dark Mode

The decision to build [blazordiffusion.com](https://blazordiffusion.com) was in large part due to choosing an App that would look best in Dark Mode, as-is often preferred when viewing images and video. The public UI uses [JS.init() to force Dark Mode](https://github.com/NetCoreApps/BlazorDiffusion/blob/v0.1/BlazorDiffusion/Pages/_Layout.cshtml#L63) whilst the Admin Pages uses a different [AdminLayout.razor](https://github.com/NetCoreApps/BlazorDiffusion/blob/v0.1/BlazorDiffusion/Shared/AdminLayout.razor) that allows dark mode to be toggled on/off as seen in the [BlazorDiffusion Video](https://www.youtube.com/watch?v=tt0ytzVVjEY).

### AutoComplete

The [Create.razor](https://github.com/NetCoreApps/BlazorDiffusion/blob/v0.1/BlazorDiffusion/Pages/Create.razor) uses the new `<Autocomplete>` to quickly select Artists 
and Modifiers.

<div class="mt-8 flex justify-center">
    <a href="https://github.com/NetCoreApps/BlazorDiffusion/blob/main/BlazorDiffusion/Pages/Create.razor">
        <img src="/img/pages/blazor/blazordiffusion-Autocomplete.png" style="width:600px">
    </a>
</div>

### Admin Pages

The [/admin](https://github.com/NetCoreApps/BlazorDiffusion/tree/main/BlazorDiffusion/Pages/admin) pages we're all built using [AutoQueryGrid](https://blazor-gallery.jamstacks.net/grid) for its data management and uses [NavList and Breadcrumbs](https://blazor-gallery.jamstacks.net/gallery/navigation) for its navigation.

<div class="flex justify-center">
    <a href="https://github.com/NetCoreApps/BlazorDiffusion/blob/main/BlazorDiffusion/Pages/admin/Index.razor">
        <img src="/img/pages/blazor/blazordiffusion-admin-pages.png" style="width:600px">
    </a>
</div>

#### EditForm

The following components make use of `<EditForm>` AutoQueryGrid extensibility to display unique forms for their custom workflow requirements:

 - [Creatives.razor](https://github.com/NetCoreApps/BlazorDiffusion/blob/main/BlazorDiffusion/Pages/admin/Creatives.razor)
 - [ArtifactAutoQueryGrid.razor](https://github.com/NetCoreApps/BlazorDiffusion/blob/main/BlazorDiffusion/Shared/admin/ArtifactAutoQueryGrid.razor)
 - [ArtifactReportsAutoQueryGrid.razor](https://github.com/NetCoreApps/BlazorDiffusion/blob/main/BlazorDiffusion/Shared/admin/ArtifactReportsAutoQueryGrid.razor)

```csharp
<AutoQueryGrid @ref=@grid Model="Creative" Apis="Apis.AutoQuery<QueryCreatives,UpdateCreative,HardDeleteCreative>()"
               ConfigureQuery="ConfigureQuery">
    <EditForm>
        <div class="relative z-10" aria-labelledby="slide-over-title" role="dialog" aria-modal="true">
            <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16">
                <CreativeEdit Creative="context" OnClose="grid!.OnEditDone" />
            </div>
        </div>
    </EditForm>
</AutoQueryGrid>
```

### SelectInput

The [Modifiers.razor](https://github.com/NetCoreApps/BlazorDiffusion/blob/main/BlazorDiffusion/Pages/admin/Modifiers.razor) admin page uses 
[SelectInput EvalAllowableValues](https://github.com/NetCoreApps/BlazorDiffusion/blob/v0.1/BlazorDiffusion.ServiceModel/Creative.cs#L168-L187) feature to populate its options from a C# [AppData](https://github.com/NetCoreApps/BlazorDiffusion/blob/v0.1/BlazorDiffusion.ServiceModel/AppData.cs) property:

```csharp
public class CreateModifier : ICreateDb<Modifier>, IReturn<Modifier>
{
    [ValidateNotEmpty, Required]
    public string Name { get; set; }
    [ValidateNotEmpty, Required]
    [Input(Type="select", EvalAllowableValues = "AppData.Categories")]
    public string Category { get; set; }
    public string? Description { get; set; }
}
```

<div class="mt-8 flex justify-center">
    <img src="/img/pages/blazor/diffusion-CreateModifier.png" class="max-w-screen-md" style="border:1px solid #CACACA">
</div>

### TagInput

The [Artists.razor](https://github.com/NetCoreApps/BlazorDiffusion/blob/main/BlazorDiffusion/Pages/admin/Artists.razor) admin page uses [declarative TagInput](https://github.com/NetCoreApps/BlazorDiffusion/blob/v0.1/BlazorDiffusion.ServiceModel/Creative.cs#L122-L141) to render its AutoQueryGrid Create and Edit Forms:

```csharp
public class UpdateArtist : IPatchDb<Artist>, IReturn<Artist>
{
    public int Id { get; set; }
    public string? FirstName { get; set; }
    public string? LastName { get; set; }
    public int? YearDied { get; set; }
    [Input(Type = "tag"), FieldCss(Field = "col-span-12")]
    public List<string>? Type { get; set; }
}
```

<div class="my-8 flex justify-center">
    <img src="/img/pages/blazor/blazordiffusion-TagInput.png" class="max-w-screen-md" style="border:1px solid #CACACA">
</div>

<h2 id="litestream" class="mx-auto max-w-screen-md text-center py-8 border-none">
    <a href="https://litestream.io">
        <img src="/img/pages/litestream/logo.svg">
    </a>
</h2>

We're excited to be able to leverage our [support for Litestream](/ormlite/litestream) and showcase an example of architecting a production App at minimal cost which avoids paying for expensive managed hosted RDBMS's by effortlessly replicating its SQLite databases to object storage.

<div class="mt-16 mx-auto max-w-7xl px-4">
    <div class="text-center">
        <h3 class="text-4xl tracking-tight font-extrabold text-gray-900 sm:text-5xl md:text-6xl">
            <span class="block xl:inline">Reduce Complexity &amp; Save Costs</span>
        </h3>
        <p class="mt-3 max-w-md mx-auto text-base text-gray-500 sm:text-lg md:mt-5 md:text-xl md:max-w-3xl">
            Avoid expensive managed RDBMS servers, reduce deployment complexity, eliminate 
            infrastructure dependencies & save order of magnitude costs vs production hosting
        </p>
    </div>
    <img src="/img/pages/litestream/litestream-costs.svg">
</div>

To make it easy for Blazor Tailwind projects to take advantage of our first-class [Litestream support](/ormlite/litestream), we've created a new video combining these ultimate developer experience & value combo solutions that walks through how to deploy a new Blazor Tailwind SQLite + Litestream App to any Linux server with SSH access, Docker and Docker Compose:

<lite-youtube class="w-full mx-4 my-4" width="560" height="315" videoid="fY50dWszpw4" style="background-image: url('https://img.youtube.com/vi/fY50dWszpw4/maxresdefault.jpg')"></lite-youtube>

### Useful Blazor Litestream Video Links

- [Blazor Litestream Tutorial](/blazor-litestream)
- [Blazor](https://servicestack.net/blazor)
- [Litestream](https://servicestack.net/litestream)
- [Docker Install](https://docs.docker.com/engine/install/ubuntu/)
- [Docker Compose Install](https://docs.docker.com/compose/install/linux/#install-using-the-repository)

### Custom SQLite functions

Using SQLite also gives us access to features not available in other RDBMS's, e.g. for the "Explore Similar Artifacts" feature we're using a custom registered C# function that we can use in SQL to find other Artifacts with the nearest background colors in [SearchService.cs](https://github.com/NetCoreApps/BlazorDiffusion/blob/v0.1/BlazorDiffusion.ServiceInterface/SearchService.cs):

```csharp
public static class DbFunctions
{
    public static void RegisterBgCompare(this IDbConnection db)
    {
        var sqliteConn = (SqliteConnection)db.ToDbConnection();
        sqliteConn.CreateFunction("bgcompare", (string a, string b) => ImageUtils.BackgroundCompare(a, b));
    }
}
```

After registering the function with the db connection we can reference it in our typed SQL Expression with OrmLite's `Sql.Custom()` API:

```csharp
db.RegisterBgCompare();
q.SelectDistinct<Artifact, Creative>((a, c) => new {
    a,
    c.UserPrompt,
    c.ArtistNames,
    c.ModifierNames,
    c.PrimaryArtifactId,
    Similarity = Sql.Custom($"bgcompare('{similarToArtifact.Background}',Background)"),
});
```

This same technique is also used for finding similar images by [PerceptualHash](https://www.hackerfactor.com/blog/index.php?/archives/432-Looks-Like-It.html), [AverageHash](https://www.hackerfactor.com/blog/index.php?/archives/432-Looks-Like-It.html) & [DifferenceHash](http://01101001.net/programming.php) functions provided by the [ImageHash](https://github.com/coenm/ImageHash) library.

The [SearchService.cs](https://github.com/NetCoreApps/BlazorDiffusion/blob/v0.1/BlazorDiffusion.ServiceInterface/SearchService.cs) itself is a great example of a complex [custom AutoQuery implementation](/autoquery/rdbms#custom-autoquery-implementations) which is solely responsible for providing the entire search functionality on the home page. 

### Hetzner US Cloud

Our analysis of [US Cloud Hosting Providers](https://servicestack.net/blog/finding-best-us-value-cloud-provider) led us to moving to [Hetzner Cloud](https://www.hetzner.com/cloud) for hosting where it costs vastly less than equivalent specs at a major cloud provider. But this also meant we also had to look elsewhere to also avoid AWS's expensive egress costs for S3 for image storage which can easily get out of control for a highly traffic image host. 

### R2 Virtual Files Provider

Fortunately we were in time to take advantage of Cloudflare's inexpensive [R2 Object Storage solution](https://www.cloudflare.com/products/r2/) with **$0 egress fees**, together with their generous free tier and ability to serve R2 assets behind their free CDN, we ended up with great value and performance managed cloud storage solution with the only cost expected in the near future to be R2's **$0.015 / GB storage** cost.

R2 is mostly S3 compatible however it needed a custom `S3VirtualFiles` provider to workaround missing features which is being maintained in the new `R2VirtualFiles` VFS provider.

### Files Upload Transformer

The [Managed Files Upload Feature](/locode/files-overview) is configured in [Configure.AppHost.cs](https://github.com/NetCoreApps/BlazorDiffusion/blob/main/BlazorDiffusion/Configure.AppHost.cs) and used for all website File Uploads:

```csharp
var appFs = VirtualFiles = new R2VirtualFiles(s3Client, appConfig.ArtifactBucket);
Plugins.Add(new FilesUploadFeature(
    new UploadLocation("artifacts", appFs,
        readAccessRole: RoleNames.AllowAnon,
        maxFileBytes: AppData.MaxArtifactSize),
    new UploadLocation("avatars", appFs, allowExtensions: FileExt.WebImages, 
        // Use unique URL to invalidate CDN caches
        resolvePath: ctx => X.Map((CustomUserSession)ctx.Session, x => $"/avatars/{x.RefIdStr[..2]}/{x.RefIdStr}/{ctx.FileName}")!,
        maxFileBytes: AppData.MaxAvatarSize,
        transformFile:ImageUtils.TransformAvatarAsync)
    ));
```

Our usage highlighted it was missing the ability to transform an uploaded file and save a reference to the transformed file instead, a feature now possible with the new **transformFile:** option. This is used to only save a reference to the **128x128** resized avatar used by the App, whilst still persisting the original uploaded image in a [Background MQ](/background-mq) task in case a higher resolution of their avatar is needed later.

```csharp
public class ImageDetails
{
    public static async Task<IHttpFile?> TransformAvatarAsync(FilesUploadContext ctx)
    {
        var originalMs = await ctx.File.InputStream.CopyToNewMemoryStreamAsync();

        // Offload persistance of original image to background task
        using var mqClient = HostContext.AppHost.GetMessageProducer(ctx.Request);
        mqClient.Publish(new DiskTasks {
            SaveFile = new() {
                FilePath = ctx.Location.ResolvePath(ctx),
                Stream = originalMs,
            }
        });

        var resizedMs = await CropAndResizeAsync(originalMs, 128, 128, PngFormat.Instance);

        return new HttpFile(ctx.File)
        {
            FileName = $"{ctx.FileName.LastLeftPart('.')}_128.{ctx.File.FileName.LastRightPart('.')}",
            ContentLength = resizedMs.Length,
            InputStream = resizedMs,
        };
    }

    public static async Task<MemoryStream> CropAndResizeAsync(Stream inStream, int width, int height, IImageFormat format)
    {
        var outStream = new MemoryStream();
        var image = await Image.LoadAsync(inStream);
        using (image)
        {
            var clone = image.Clone(context => context
                .Resize(new ResizeOptions {
                    Mode = ResizeMode.Crop,
                    Size = new Size(width, height),
                }));
            await clone.SaveAsync(outStream, format);
        }
        outStream.Position = 0;
        return outStream;
    }
}
```

### Background MQ

[Background MQ](/background-mq) is utilized to improve API response times by offloading a number of non-essential background tasks in [BackgroundMqServices.cs](https://github.com/NetCoreApps/BlazorDiffusion/blob/main/BlazorDiffusion.ServiceInterface/BackgroundMqServices.cs) to perform functions like:

 - Saving JSON metadata snapshot of Stable Diffusion generated images alongside the images themselves
 - Write Files to R2
 - Recalculating temporal scores and ranking of Artifacts and Albums
 - Recording Analytics
 - Prerendering pages at runtime

### Prerendering Blazor Pages at runtime

The [current prerendering solution](https://blazor-tailwind.jamstacks.net/docs/prerender) built into the Blazor WASM template follows the [JAMStack](https://jamstack.org/) approach of pre-rendering pages at build time, however in order to keep the home page "fresh" and show the newest & most liked images first we needed a solution that pre-renders pages at runtime and publishes them to R2 object storage where the Blazor WASM static assets are deployed to. 

This feature is implemented in [Configure.Ui.cs](https://github.com/NetCoreApps/BlazorDiffusion/blob/main/BlazorDiffusion/Configure.Ui.cs) where it lets you specify the pages to render, any custom parameters and where to save it:

```csharp
container.Register<IPrerenderer>(c => new Prerenderer
{
    BaseUrl = appConfig.BaseUrl,
    VirtualFiles = virtualFiles,
    PrerenderDir = "/prerender",
    Renderer = c.Resolve<IComponentRenderer>(),
    Pages = {
        new(typeof(Pages.Index),  "/index.html",  new() { [nameof(Pages.Index.LazyLoad)] = "false" }),
        new(typeof(Pages.Albums), "/albums.html", new() { [nameof(Pages.Index.LazyLoad)] = "false" }),
    }
});
```

To avoid a dependency to bUnit in our App we've created a new `ComponentRenderer` to render Blazor components to string that's useful if needing to render a Blazor Component to HTML in an API, e.g. you can create a generic API to render any component with:

```csharp
[Route("/render/{Type}")]
public class RenderComponent : IGet, IReturn<string> 
{
    public string Type { get; set; }
}

//...

public async Task<object> Any(RenderComponent request)
{
    var componentType = GetComponentType(request.Type); //TODO resolve Component Type from Name
    var httpContext = ((NetCoreRequest)Request).HttpContext;
    var args = Request.GetRequestParams().ToObjectDictionary();
    var renderer = new ComponentRender();
    var html = await renderer.RenderComponentAsync(componentType, httpContext, args);
    return html;
}
```

Where it will populate a component instance from a QueryString then render it to string that can be called like:

    /render/MyPage?Param1=A&Param2=B

Or if needing to render a component outside of a HTTP Context (e.g. in a Background Task or Console App), you can create a empty HttpContext with the new `HttpContextFactory`, e.g:

```csharp
var testContext = HttpContextFactory.CreateHttpContext(baseUrl);
var renderer = new ComponentRender();
var html = await renderer.RenderComponentAsync(componentType, testContext, args);
```

## Universal Blazor Components

Blazor Server has become our preferred platform for Interactive **Intranet** Apps which excels in **low-latency environments** to enable a best-in-class responsive end-user UX that also offers a superior development experience in Visual Studio's live reload where it enables a fast iterative development workflow and good debugging experience.

A fantastic property of Blazor is its support for multiple hosting modes which allows the same components from being able to run in the Browser with Blazor WASM or rendered on the Server with Blazor Server. But whilst Blazor is capable of it, this trait is typically conceded in most Apps with database access where it recommends using
[EF Core directly in Blazor components](https://learn.microsoft.com/en-us/aspnet/core/blazor/blazor-server-ef-core?view=aspnetcore-7.0) - effectively prohibiting reuse in Blazor WASM should you ever want to utilize Blazor's preferred hosting model for hosting your Blazor App's on the Internet.

<div class="my-8 flex justify-center">
    <lite-youtube class="w-full mx-4 my-4" width="560" height="315" videoid="66DgLHExC9E" style="background-image: url('https://img.youtube.com/vi/66DgLHExC9E/maxresdefault.jpg')"></lite-youtube>
</div>

## Blazing Fast Networkless APIs

Whilst better performing, having Blazor components access DB's directly encourages a more tightly-coupled and less reusable & testable architecture than the traditional well-defined API dev model used in client/server Mobile & Desktop Apps or Web SPA Apps like WASM. 

To achieve the best of both worlds, we've enabled support for utilizing the In Process [Service Gateway](/service-gateway) in Blazor Server Apps which lets you retain the traditional client/server dev model for invoking your Server APIs **In Process** - avoiding any serialization, HTTP networking or even Kestrel middleware overhead to invoke your APIs directly!

This enables using the **exact same source code** to call APIs in Blazor Server and WASM which allows us to develop reusable Blazor Components to invoke the same Server APIs that serve Web, Mobile and Desktop Apps in Blazor Server Apps. Where instead of using HttpClient to invoke your APIs, they're invoked directly from a C# method which will preserve its StackTrace where you'll be able to track the API call down to the Blazor UI component calling it.

ServiceStack's [Message-based API Design](/api-design) makes it possible for all API calls in ServiceStack.Blazor components and project templates to be routed through these 2 methods:

```csharp
public interface IServiceGatewayAsync
{
    Task<TResponse> SendAsync<TResponse>(object dto, CancellationToken ct=default);
    //...
}

public interface IServiceGatewayFormAsync
{
    Task<TResponse> SendFormAsync<TResponse>(object dto, MultipartFormDataContent form, CancellationToken ct=default);
}
```

::: info
The `SendFormAsync` API is a new method added to support multi-part API requests with File Uploads
:::

Which allows the HTTP `JsonApiClient` and networkless `InProcessGateway` clients to be used interchangeably. By default Blazor Server Apps now use the InProcess Gateway but can be switched over to invoke APIs using the HTTP `JsonApiClient` with:

```csharp
BlazorConfig.Set(new() {
    UseInProcessClient = false
});
```

Which changes all `Api*` methods in Blazor components and Pages inheriting ServiceStack.Blazor's [BlazorComponentBase](https://reference.servicestack.net/api/ServiceStack.Blazor/BlazorComponentBase) to use the registered `JsonApiClient` client. 

Other components can access both the InProcess Gateway or `JsonApiClient` by injecting the `IClientFactory` dependency into their components, e.g:

```csharp
public class MyComponent : ComponentBase
{
    [Inject] public IClientFactory? ClientFactory { get; set; }

    public IServiceGateway Gateway => ClientFactory!.GetGateway();
    public JsonApiClient Client => ClientFactory!.GetClient();
}
```

This capability is what has made it possible for high-level "API-enabled" components like [AutoQuery Grids](https://blazor-gallery.jamstacks.net/grid) and [AutoForm](https://blazor-gallery.jamstacks.net/gallery/autoform) to support both Blazor Server and Blazor WASM utilizing the most efficient API client available to its platform.

The Blazor Gallery websites themselves are also good demonstrations of being able to run **entire Web Apps** in both Blazor Server and WASM, with all development being done with Blazor Server to take advantage of its superior iterative dev model then a script is used to "export" all pages to an identical Blazor WASM project.

<p class="hide-h2"></p>

## Blazor Gallery

<div id="blazor-component-gallery" class="relative bg-white dark:bg-black py-4">
  <div class="mx-auto max-w-md px-4 text-center sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8">
    <p class="mt-2 text-3xl font-extrabold tracking-tight text-gray-900 dark:text-gray-50 sm:text-4xl">Blazor Gallery</p>
    <p class="mx-auto mt-5 max-w-prose text-xl text-gray-500">
      Discover ServiceStack.Blazor's Rich UI Components
    </p>
  </div>
</div>

[![](/img/pages/blazor/gallery-splash.png)](https://blazor-gallery.servicestack.net)

Checkout sites below to see ServiceStack.Blazor components running on both **Blazor Server** and **WASM**:

<div class="not-prose mb-16 mx-auto mt-5 max-w-md sm:flex sm:justify-center md:mt-8">
  <div class="rounded-md shadow">
    <a href="https://blazor-gallery.servicestack.net" class="flex w-full items-center justify-center rounded-md border border-transparent bg-indigo-600 px-8 py-3 text-base font-medium text-white hover:bg-indigo-700 md:py-4 md:px-10 md:text-lg hover:no-underline">
      Blazor Server
    </a>
  </div>
  <div class="mt-3 rounded-md shadow sm:mt-0 sm:ml-3">
    <a href="https://blazor-gallery.jamstacks.net" class="flex w-full items-center justify-center rounded-md border border-transparent bg-white px-8 py-3 text-base font-medium text-indigo-600 hover:bg-gray-50 md:py-4 md:px-10 md:text-lg hover:no-underline">
      Blazor WASM
    </a>
  </div>
</div>

For a closer look at ServiceStack.Blazor Components in action, they can be downloaded & run locally from:

<div class="py-8 flex justify-center">
    <div class="flex flex-col">
    <a href="https://github.com/NetCoreApps/BlazorGallery" class="flex text-xl text-gray-800">
        <svg class="w-6 h-6 mr-2 align-text-bottom" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 .297c-6.63 0-12 5.373-12 12c0 5.303 3.438 9.8 8.205 11.385c.6.113.82-.258.82-.577c0-.285-.01-1.04-.015-2.04c-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729c1.205.084 1.838 1.236 1.838 1.236c1.07 1.835 2.809 1.305 3.495.998c.108-.776.417-1.305.76-1.605c-2.665-.3-5.466-1.332-5.466-5.93c0-1.31.465-2.38 1.235-3.22c-.135-.303-.54-1.523.105-3.176c0 0 1.005-.322 3.3 1.23c.96-.267 1.98-.399 3-.405c1.02.006 2.04.138 3 .405c2.28-1.552 3.285-1.23 3.285-1.23c.645 1.653.24 2.873.12 3.176c.765.84 1.23 1.91 1.23 3.22c0 4.61-2.805 5.625-5.475 5.92c.42.36.81 1.096.81 2.22c0 1.606-.015 2.896-.015 3.286c0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
        <span>NetCoreApps/BlazorGallery</span>
    </a>
    <a href="https://github.com/NetCoreApps/BlazorGalleryWasm" class="flex mt-2 text-xl text-gray-800">
        <svg class="w-6 h-6 mr-2 align-text-bottom" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 .297c-6.63 0-12 5.373-12 12c0 5.303 3.438 9.8 8.205 11.385c.6.113.82-.258.82-.577c0-.285-.01-1.04-.015-2.04c-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729c1.205.084 1.838 1.236 1.838 1.236c1.07 1.835 2.809 1.305 3.495.998c.108-.776.417-1.305.76-1.605c-2.665-.3-5.466-1.332-5.466-5.93c0-1.31.465-2.38 1.235-3.22c-.135-.303-.54-1.523.105-3.176c0 0 1.005-.322 3.3 1.23c.96-.267 1.98-.399 3-.405c1.02.006 2.04.138 3 .405c2.28-1.552 3.285-1.23 3.285-1.23c.645 1.653.24 2.873.12 3.176c.765.84 1.23 1.91 1.23 3.22c0 4.61-2.805 5.625-5.475 5.92c.42.36.81 1.096.81 2.22c0 1.606-.015 2.896-.015 3.286c0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
        <span>NetCoreApps/BlazorGalleryWasm</span>
    </a>
    </div>
</div>

## Unified Authentication

Authentication was a particularly challenging feature to get working in Blazor Server Apps and maintained in-sync across:

 - Users's Authentication State in the Blazor Server App (Server Rendering SignalR Circuit)
 - Authenticated HttpClient used to Sign In and make Authenticated API Requests
 - Authenticated Browser Session

Where the default behaviour after authenticating in a Blazor App with an App's `AuthenticationStateProvider` was maintaining a "disconnected" Authentication state separate from the external browser session as "authenticating" in Blazor Server would not authenticate the Browser and a full page refresh would lose the Users Authenticated State, another issue was after a while the "Authenticated HttpClient" used to Authenticate the user and make authenticated API requests would be lost, resulting in the Authenticated user losing the ability to make Authenticated HttpClient Requests.

This was especially surprising given the recommendation is to use [HttpClientFactory to resolve HttpClients](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/http-requests?view=aspnetcore-7.0), unfortunately the scopes used to resolve HttpClients and its Message Handlers is different to the App's scope used to maintain User's Authentication State where we were witnessing the Authenticated HttpClient Instances (configured with JWT Cookies) would get lost over time, a behavior identified in Andrew Lock's excellent post explaining [HttpClient Message Handlers DI Scopes](https://andrewlock.net/understanding-scopes-with-ihttpclientfactory-message-handlers/).

Fortunately the post does include a workaround for being able to access the App's same 
[Request Scope by using HttpContextAccessor](https://andrewlock.net/understanding-scopes-with-ihttpclientfactory-message-handlers/#accessing-the-request-scope-from-a-custom-httpmessagehandler). Unfortunately whilst this approach did work, further research into using HttpClient in Blazor Server Apps revealed this approach [should not be used in Blazor Server Apps](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/http-context?view=aspnetcore-6.0#blazor-and-shared-state):

::: warning
**Additionally, again for security reasons, you must not use IHttpContextAccessor within Blazor apps.** Blazor apps run outside of the context of the ASP.NET Core pipeline. The HttpContext isn't guaranteed to be available within the IHttpContextAccessor, nor is it guaranteed to be holding the context that started the Blazor app
:::

This was particularly concerning since using `IHttpContextAccessor` was the only solution that ever worked in successfully maintaining Authentication state across Blazor Server App, HttpClient and external Browser session, and as such is frequently promoted as the solution for implementing [Blazor Server Cookie Authentication](https://www.learmoreseekmore.com/2022/01/part3-blazorsrver-cookie-authentication.html) or [Calling protected APIs with Auth0](https://auth0.com/blog/call-protected-api-in-aspnet-core/).

Luckily we were able to get the desired authentication functionality by adopting Microsoft's "recommended way to pass request state to the Blazor app" through parameters to the root component which required breaking changes to [_Host.cshtml](https://github.com/NetCoreTemplates/blazor-server/blob/main/MyApp/Pages/_Host.cshtml) to pass the Browser's Request Session to the App:

```cs
<component type="typeof(App)" param-InitialState="Request.GetInitialHostState()" render-mode="ServerPrerendered" />
```

Where this initial State is loaded into the App's scoped `HostState` context in [App.razor](https://github.com/NetCoreTemplates/blazor-server/blob/main/MyApp/App.razor):

```csharp
@code {
    [Parameter] public InitialHostState? InitialState { get; set; }

    protected override Task OnInitializedAsync()
    {
        HostState.Load(InitialState);
        return base.OnInitializedAsync();
    }
}
```

Together with a custom `AuthenticationStateProvider` using JavaScript to serialize Blazor Server authentication tokens to Browser Cookies and a custom `IClientFactory` that utilizes the `HostState` to recreate an Authenticated HttpClient we were finally able to achieve the desired objective of keeping Blazor Server App Authentication in sync with the external Browser Session and HttpClient.

Now new Blazor Server Apps are able to Sign In externally, e.g. through standard OAuth workflow or the [Integrated Sign In](/api-explorer#integrated-sign-in) in API Explorer, Admin UI or Locode and this Authenticated state will be able to be passed into the Blazor Server App to Authenticate the user, likewise Authenticating in Blazor Server will update the Browser Cookies to authenticate the external browser session resulting in the desired and expected Unified Authentication behavior!

<div class="bg-gray-200 flex justify-center py-16">
    <img src="/img/pages/admin-ui/admin-ui-signin.png" style="width:500px;border-left:1px solid #CACACA;border-bottom:1px solid #CACACA">
</div>

## Upgrading existing Blazor Projects

To make use of new Blazor Features in this release, existing Blazor Server and WASM templates will need to include the latest tailwind classes ServiceStack.Blazor uses by updating:

 - [/wwwroot/tailwind/ServiceStack.Blazor.html](https://github.com/NetCoreTemplates/blazor-server/blob/main/MyApp/wwwroot/tailwind/ServiceStack.Blazor.html) 

It's not required, but we recommend calling `JS.init()` to initialize ServiceStack.Blazor's JS helper after importing it in [_Layout.cshtml](https://github.com/NetCoreTemplates/blazor-server/blob/main/MyApp/Pages/_Layout.cshtml) in Blazor Server or [index.html](https://github.com/NetCoreTemplates/blazor-tailwind/blob/main/MyApp.Client/wwwroot/index.html) in WASM:

```html
<script src="/js/servicestack-blazor.js"></script>
<script>JS.init()</script>
```
  
To avoid future breaking changes to the base constructor when needing access to new dependencies, the Blazor WASM [/Auth/ServiceStackStateProvider.cs](https://github.com/NetCoreTemplates/blazor-tailwind/blob/main/MyApp.Client/Auth/ServiceStackStateProvider.cs) was changed to inject a context encapsulating all its required dependencies:

```csharp
public class ServiceStackStateProvider : BlazorWasmAuthenticationStateProvider
{
    public ServiceStackStateProvider(BlazorWasmAuthContext ctx, ILogger<BlazorWasmAuthenticationStateProvider> log)
        : base(ctx, log) { }
}
```

Whilst Blazor Server's [/Auth/ServiceStackStateProvider.cs](https://github.com/NetCoreTemplates/blazor-server/blob/main/MyApp/Auth/ServiceStackStateProvider.cs) was changed to:

```csharp
public class ServiceStackStateProvider : BlazorServerAuthenticationStateProvider
{
    public ServiceStackStateProvider(BlazorServerAuthContext ctx, ILogger<BlazorServerAuthenticationStateProvider> log) 
        : base(ctx, log) {}
}
```

As described above the [/Pages/_Host.cshtml](https://github.com/NetCoreTemplates/blazor-server/blob/main/MyApp/Pages/_Host.cshtml) and [App.razor](https://github.com/NetCoreTemplates/blazor-server/blob/main/MyApp/App.razor) will also need updating to utilize Blazor Server's Unified Authentication.

## Add ServiceStack Reference

The native types code generation in [Add ServiceStack Reference](/add-servicestack-reference) was improved to better support C# nullable annotations where this mixed type containing both value and reference nullable types:

```csharp
public class Data
{
    public int Value { get; set; }
    public int? OptionalValue { get; set; }
    public string Text { get; set; }
    public string? OptionalText { get; set; }

    [Required]
    public int RequiredValue { get; set; }
    [Required]
    public string RequiredText { get; set; }

    // Override default behavior
    [ApiMember(IsRequired=true)]
    public string? OverrideRequiredText { get; set; }

    [ApiMember(IsOptional=true)]
    public string OverrideOptionalText { get; set; }
}
```

Now generate the expected TypeScript DTO:

```ts
export class Data
{
    public value: number;
    public optionalValue?: number;
    public text: string;
    public optionalText?: string;
    // @Required()
    public requiredValue: number;

    // @Required()
    public requiredText: string;

    // @ApiMember(IsRequired=true)
    public overrideRequiredText: string;

    // @ApiMember(IsOptional=true)
    public overrideOptionalText?: string;
    //...
}
```

The C# Types Generator now also supports generating nullable reference types that your C# clients can opt-in to with the new `AddNullableAnnotations` option, e.g:

```csharp
/* Options:
Date: 2022-12-06 11:03:22
Version: 6.41
Tip: To override a DTO option, remove "//" prefix before updating
BaseUrl: https://localhost:5001

//GlobalNamespace: 
AddNullableAnnotations: True
IncludeTypes: Data
//...
*/

public partial class Data
{
    public virtual int Value { get; set; }
    public virtual int? OptionalValue { get; set; }
    public virtual string Text { get; set; }
    public virtual string? OptionalText { get; set; }

    [Required]
    public virtual int RequiredValue { get; set; }

    [Required]
    public virtual string RequiredText { get; set; }

    [ApiMember(IsRequired=true)]
    public virtual string OverrideRequiredText { get; set; }

    [ApiMember(IsOptional=true)]
    public virtual string? OverrideOptionalText { get; set; }
}
```

If most of your C# clients prefer their C# DTOs to have nullable type references, this default behavior can be changed with:

```csharp
ConfigurePlugin<NativeTypesFeature>(feature => feature.MetadataTypesConfig.AddNullableAnnotations = true);
```

## ServiceStack.Logging
 
To avoid breaking changes `ILogTrace` was added as an optional interface that [ServiceStack.Logging providers](/logging) can choose to implement if they support trace level logging, which the new `ILog.Trace()` and `ILog.TraceFormat()` extension methods will use if it exists, otherwise falls back to Debug Logging.
